<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width,height=device-height,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
    <title>C# tips</title>
</head>
<body>
<h2>bash</h2>
<pre>
export ANDROID_HOME=/usr/local/opt/android-sdk
source ~/.bashrc
</pre>
<h2>git submodule</h2>
<pre>
git submodule update --init --recursive
</pre>
<h2>react with babel</h2>
<pre>
let babel = require("gulp-babel");
for (let file of jsxFiles) {
    gulp.src(`components/${file}.jsx`)
        .pipe(babel())
        .pipe(rename(`${file}.js`))
        .pipe(gulp.dest("build"));
}

`.babelrc`
{
    "presets": ["es2015", "react"]
}
</pre>
<h2>nginx proxy</h2>
<pre>
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }
    server {
        listen       9998;
        server_name  localhost;

        location ~*/socket.io/* {
            proxy_pass https://yorkyao.xyz;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
        }

        location / {
            add_header Access-Control-Allow-Origin http://localhost:8888;
            proxy_pass https://yorkyao.xyz;
        }
    }
    server {
        listen       9999;
        server_name  localhost;

        location / {
            add_header Access-Control-Allow-Origin http://localhost:8888;
            proxy_pass https://img.yorkyao.xyz;
        }
    }
    server {
        listen       7777;
        server_name  localhost;

        location / {
            proxy_pass https://img.yorkyao.xyz;
        }
    }
</pre>
<h2>nginx sample</h2>
<pre>
    gzip  on;
    gzip_http_version 1.1;
    gzip_vary on;
    gzip_comp_level 6;
    gzip_proxied any;
    gzip_types text/plain application/x-javascript text/css text/javascript application/x-httpd-php image/jpeg image/gif image/png;
    gzip_buffers 16 8k;
    gzip_disable "MSIE [1-6]\.(?!.*SV1)";

    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    keepalive_timeout   65;
    types_hash_max_size 2048;

    include             /etc/nginx/mime.types;
    default_type        application/octet-stream;

    # Load modular configuration files from the /etc/nginx/conf.d directory.
    # See http://nginx.org/en/docs/ngx_core_module.html#include
    # for more information.
    include /etc/nginx/conf.d/*.conf;

    server {
        listen       80;
        return       301 https://$host$request_uri;
    }

    upstream deployRobot {
        server localhost:9996;
    }
    server {
        listen       9995 ssl http2;
        listen       [::]:9995;
        ssl on;
        ssl_certificate /opt/1_yorkyao.xyz_bundle.crt;
        ssl_certificate_key /opt/ssl.key;
        server_name  yorkyao.xyz;

        location / {
            proxy_pass http://deployRobot;
        }
    }

    upstream imageUploader {
        server localhost:9999;
    }
    server {
        listen       443 ssl http2;
        listen       [::]:443;
        ssl on;
        ssl_certificate /opt/1_img.yorkyao.xyz_bundle.crt;
        ssl_certificate_key /opt/img_ssl.key;
        server_name  img.yorkyao.xyz;

        location ~*\.(jpg|jpeg|gif|png|ico|cur|gz|svg|svgz)$ {
            root         /opt/backends/images/;
            access_log off;
        }
        location / {
            proxy_pass http://imageUploader;
        }
    }

    server {
        listen       443 ssl http2;
        listen       [::]:443;
        ssl on;
        ssl_certificate /opt/1_doc.yorkyao.xyz_bundle.crt;
        ssl_certificate_key /opt/doc_ssl.key;
        server_name  doc.yorkyao.xyz;

        location ~*\.(js|css|jpg|jpeg|gif|png|ico|cur|gz|svgz|map|mp4|ogg|ogv|webm|htc|json|ttf|woff)$ {
            root         /opt/doc/_book;
            expires 1M;
            access_log off;
            add_header Cache-Control public;
        }
        location ~*\.(html|svg)$ {
            root         /opt/doc/_book;
            index index.html;
            access_log off;
        }
    }

    upstream backends {
        server localhost:9998;
    }
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }
    server {
        listen       443 ssl http2;
        listen       [::]:443;
        ssl on;
        ssl_certificate /opt/1_yorkyao.xyz_bundle.crt;
        ssl_certificate_key /opt/ssl.key;
        server_name yorkyao.xyz www.yorkyao.xyz;

        location ~*/socket.io/* {
            proxy_pass http://backends;
	        proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
        }
        location ~*\.(js|css|jpg|jpeg|gif|png|ico|cur|gz|svg|svgz|map|mp4|ogg|ogv|webm|htc|json|ttf|woff)$ {
            root         /opt/frontends/dest/;
            expires 1M;
            access_log off;
            add_header Cache-Control public;
        }
        location ~*\.html$ {
            root         /opt/frontends/dest/;
            try_files $uri /index.html;
            access_log off;
        }
        location =/ {
            root         /opt/frontends/dest/;
            index index.html;
            access_log off;
        }
        location / {
            proxy_pass http://backends;
        }
    }
</pre>
<h2>SSL</h2>
<pre>
1. openssl rsa -in ssl.key -out ssl2.key
2. nginx
        listen       80;
        listen       443 ssl;
        listen       [::]:80;
        ssl on;
        ssl_certificate /opt/ssl.crt;
        ssl_certificate_key /opt/ssl2.key;
        server_name wosign.com www.wosign.com;
</pre>
<h2>XSS</h2>
<pre>
1. http only cookie
2. check the input from user
3. check the output to html
</pre>
<h2>CSRF</h2>
<pre>
1. captcha
2. check referer
3. token
</pre>
<h2>nginx</h2>
<pre>
1. install
http://nginx.org/en/docs/install.html
2. config
/etc/nginx
/usr/local/nginx/
/usr/local/etc/nginx/
3. reload
nginx -s reload
</pre>
<h2>cookie may be invalid in localhost</h2>
<h2>port</h2>
<pre>
netstat -ano | grep 80
</pre>
<h2>Segmentation fault: 11</h2>
<pre>
npm rebuild
</pre>
<h2>cron</h2>
<pre>
1. config
crontab -e
2. restart
for CentOS 5/6:
service crond restart
for CentOS 7:
systemctl restart crond.service
3. status
crontab -u root -l
service crond status
4. log
/var/log/cron
</pre>
<h2>website develop environment</h2>
<pre>
1. structure
2. cache
3. log
4. document
5. db
6. auto unit test
7. code repository
8. auto deploy
9. auto complie
10. backup
11. setting
</pre>
<h2>install mongodb</h2>
<pre>
https://www.mongodb.org/downloads

1. add admin user
mongo
use admin
db.system.users.find()
db.createUser(
  {
    user: "admin_user",
    pwd: "admin_password"
  }
)
db.auth('admin_user','admin_password')

2. add a user for a db
db.createUser(
    {
      user: "user",
      pwd: "password",
      roles: [
         { role: "readWrite", db: "db_name" }
      ]
    }
)

3. turn on auth and set ip
/etc/mongod.conf
</pre>
<h2>install redis</h2>
<pre>
http://redis.io/download
</pre>
<h2>change file format</h2>
<pre>
vim abc.sh
:set ff=unix
:set ff
:wq
</pre>
<h2>install git</h2>
<pre>
http://git-scm.com/download/linux
</pre>
<h2>install mariadb</h2>
<pre>
https://downloads.mariadb.org/mariadb/repositories/#mirror=opencas
sudo service mysql start
mysqladmin -u root password 'password'
</pre>
<h2>install nodejs</h2>
<pre>
https://github.com/joyent/node/wiki/Installing-Node.js-via-package-manager
</pre>
<h2>show pid</h2>
<pre>
ps aux | grep node
</pre>
<h2>nodejs auto deploy</h2>
<pre>
git clone XXX .
npm install --global gulp

cd XXX
git pull
gulp XXX
rsync -a XXX XXX
FOREVER_ROOT=XXX forever restart -l XXX.log XXX.js
</pre>
<h2>npm</h2>
<pre>
npm --registry https://registry.npm.taobao.org install socket.io
npm install -g n
n stable
</pre>
<h2>git</h2>
<pre>
git add -A
git reset --hard
git config --system core.longpaths true
</pre>
<h2>git pull request & fork workflow</h2>
<pre>
0. Create a team
1. Create the main repository, set permissions, clone, commit, push
2. Fork the repository, clone, commit, push, create pull request
3. Merge
</pre>
<h2>centos</h2>
<pre>
1. query memory
free -m
2. ssh
ssh -p 22 root@1.1.1.1
3. dns
/etc/resolv.conf
5. disk free in MB
df -m
6. query cpu status
top
q
7. query cpu
cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c 
</pre>
<h2>mysql</h2>
<pre>
1. Create Database 'database1', and grant it to new user 'user1/password1'
login: 
mysql -u root -p

create database:
show databases;
create database database1;
show databases;

create user:
select User,Host,Password from mysql.user;
CREATE USER 'user1'@'%' IDENTIFIED BY 'password1';
select User,Host,Password from mysql.user;

grant permissions:
grant select,insert,update,delete,create,drop,alter,create view,show view on database1.* to user1@'%' identified by 'password1';
flush privileges;
SHOW GRANTS FOR 'user1'@'%';
2. backup
mysqldump -h 127.0.0.1 -u root -p dbname > /opt/filename.sql
3. query database size
use information_schema;
SELECT concat(round(sum(DATA_LENGTH/1024/1024),2),'MB') as data FROM TABLES WHERE table_schema='table name';
</pre>
<h2>Layout RenderSection</h2>
<pre>
1. Layout
@RenderSection("Head")
2. Body
@section Head{
    &lt;h2>Head&lt;/h2>
}
</pre>
<h2>Login by NT account</h2>
<pre>
1. Web.config
&lt;system.web>
    &lt;authentication mode="Windows">&lt;/authentication>
&lt;/system.web>
2. Code
HttpContext.Current.User.Identity.Name
3. IIS -> 身份验证
匿名是否验证：禁用
Windows验证：启用
4. IIS -> 应用程序池
v4.0/NetworkService/集成
5. 防火墙添加规则
</pre>
<h2>msi package</h2>
<pre>
msiexec /package "path-to-package"
</pre>
<h2>Comparer</h2>
<pre>
public class Product
{
    public string Name { get; set; }
    public int Code { get; set; }
}

public class ProductComparer : IEqualityComparer&lt;Product>
{
    public bool Equals(Product x, Product y)
    {
        if (Object.ReferenceEquals(x, y))
        {
            return true;
        }
        if (Object.ReferenceEquals(x, null) || Object.ReferenceEquals(y, null))
        {
            return false;
        }
        return x.Code == y.Code && x.Name == y.Name;
    }

    public int GetHashCode(Product product)
    {
        if (Object.ReferenceEquals(product, null))
        {
            return 0;
        }
        int hashProductName = product.Name == null ? 0 : product.Name.GetHashCode();
        int hashProductCode = product.Code.GetHashCode();
        return hashProductName ^ hashProductCode;
    }
}
</pre>
<h2>Unit test</h2>
<pre>
1.Run methods without run whole application
2.Unit test case shouldn't depend on other test cases
3.Use mock tool to help with that
</pre>
<h2>log4net</h2>
<pre>
[assembly: XmlConfigurator(Watch = true)]

public static class Log
{
    public static readonly ILog INSTANCE;
    static Log()
    {
        INSTANCE = LogManager.GetLogger(MethodBase.GetCurrentMethod().DeclaringType);
        if (INSTANCE == null)
        {
            throw new Exception("Log.INSTANCE == null");
        }
    }
}
</pre>

<pre>
&lt;configSections>
    &lt;section name="log4net" type="log4net.Config.Log4NetConfigurationSectionHandler,log4net" />
&lt;/configSections>
&lt;startup useLegacyV2RuntimeActivationPolicy="true">
    &lt;supportedRuntime version="v4.0" sku=".NETFramework,Version=v4.0" />
&lt;/startup>
&lt;log4net>
    &lt;root>
    &lt;appender-ref ref="UdpAppender" />
        &lt;!--&lt;appender-ref ref="RollingFileAppender"/>-->
    &lt;/root>
    &lt;appender name="UdpAppender" type="log4net.Appender.UdpAppender">
    &lt;remoteAddress value="127.0.0.1" />
    &lt;remotePort value="7071" />
        &lt;layout type="log4net.Layout.XmlLayoutSchemaLog4j" />
    &lt;/appender>
    &lt;!--&lt;appender name="RollingFileAppender" type="log4net.Appender.RollingFileAppender">
        &lt;file value="log.txt" />
        &lt;appendToFile value="true" />
        &lt;rollingStyle value="Size" />
        &lt;maxSizeRollBackups value="10" />
        &lt;maximumFileSize value="100KB" />
        &lt;staticLogFileName value="true" />
        &lt;layout type="log4net.Layout.PatternLayout">
            &lt;conversionPattern value="%date [%thread] %-5level - %message%newline" />
        &lt;/layout>
    &lt;/appender>-->
&lt;/log4net>
</pre>
<h2>web.config connectionStrings</h2>
<pre>
cd "C:\Windows\Microsoft.NET\Framework64\v4.0.30319"
aspnet_regiis.exe -pef   "connectionStrings"   "E:\inetpub\ABC" -prov "DataProtectionConfigurationProvider"
aspnet_regiis -pdf "connectionStrings" "E:\inetpub\ABC"
</pre>
<h2>file size</h2>
<pre>
&lt;form action="" method="POST" enctype="multipart/form-data">
&lt;/form>
&lt;system.web>
    &lt;httpRuntime
        maxRequestLength="40690"
        useFullyQualifiedRedirectUrl="true"
        executionTimeout="6000"
        minFreeThreads="8"
        minLocalRequestFreeThreads="4"
        appRequestQueueLimit="100"
        enableVersionHeader="true" />
&lt;/system.web>
</pre>
</body>
</html>
