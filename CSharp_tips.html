<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width,height=device-height,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
    <title>C# tips</title>
</head>
<body>
<h2>aes</h2>
<pre>
const mode = "aes-128-ecb";

export function decrypt(token: string): string {
    const decipher = libs.crypto.createDecipher(mode, key);
    return decipher.update(token, "hex", "utf8") + decipher.final("utf8");
}

function encrypt(text: string): string {
    const cipher = libs.crypto.createCipher(mode, key);
    return cipher.update(text, "utf8", "hex") + cipher.final("hex");
}
</pre>
<h2>git rebase</h2>
<pre>
git reset
git push -f
</pre>
<h2>protobuf with protobufjs</h2>
<pre>
import * as ProtoBuf from "protobufjs";
const protoBuilder = libs.ProtoBuf.loadProtoFile("./man.proto");
const ManBuilder = protoBuilder.build("Man") as any;

interface Man {
    age: number;
    name: string;
}

export function encode(man: Man): Buffer {
    const manBuilder = new ManBuilder(man);
    return manBuilder.toBuffer();
}

export function decode(buffer: Buffer): Man {
    return ManBuilder.decode(buffer);
}
</pre>
<h2>ws pressure test</h2>
<pre>
1. server
import * as WebSocket  from "ws";

const WebSocketServer = WebSocket.Server;
const port = 8080;
const wss = new WebSocketServer({
    port: port
});

setInterval(() => {
    console.log(wss.clients.length);
}, 10 * 1000);
console.log(`started at ${port}`);

2. client
import * as WebSocket  from "ws";

let connectionCount = 0;
let errorCount = 0;
let lastError;
let totalCount = 0;
const interval = 10 * 1000;
const frequency = 1000;

setInterval(() => {
    for (let i = 0; i < frequency; i++) {
        setTimeout(() => {
            const ws = new WebSocket("ws://localhost:8080/");
            ws.on("open", () => {
                connectionCount++;
            });
            ws.on("close", () => {
                connectionCount--;
            });
            ws.on("error", error => {
                errorCount++;
                lastError = error;
            });
            totalCount++;
        }, Math.random() * interval);
    }
    console.log(`${connectionCount}/${totalCount}  ${errorCount} errors`);
    if (lastError) {
        console.log(lastError);
        lastError = undefined;
    }
}, interval);
</pre>
<h2>homebrew install specific version</h2>
<pre>
brew search xyz
brew install xyz
brew unlink xyz
brew link xyz2 --force
</pre>
<h2>ssh keys</h2>
<pre>
1. client
ssh-keygen -t rsa
ssh-agent bash
ssh-add ~/.ssh/id_rsa
2. server
/etc/ssh/sshd_config
chmod 700 .ssh
cd .ssh
cat id_rsa.pub >> authorized_keys
chmod 600 authorized_keys
</pre>
<h2>install svn server at ubuntu server</h2>
<pre>
sudo apt-get install subversion
sudo svnadmin create /home/svn/demo
sudo chmod -R o+rw /home/svn
/home/svn/demo/conf/authz
```
[/]
admin = user1
@admin =rw
* =
```
/home/svn/demo/conf/passwd
```
user1 = password1
```
/home/svn/demo/conf/svnserve.conf
```
anon-access = none
auth-access = write
password-db = passwd
```
svnserve -d -r /home/svn
</pre>
<h2>set network</h2>
<pre>
sudo vim /etc/network/interfaces
auto eth0
iface eth0 inet static
address 192.168.100.40
netmask 255.255.255.0
gateway 192.168.100.1
sudo ifup eth0
sudo /etc/init.d/networking restart
sudo vim /etc/resolv.conf
nameserver 192.168.100.1

for centos:
/etc/sysconfig/network-scripts/ifcfg-eth0
nameserver 114.114.114.114
</pre>
<h2>set a cpu core for a process</h2>
<pre>
taskset -pc 7 1622
</pre>
<h2>check limit of server</h2>
<pre>
1. /etc/sysctl.conf
cat /proc/sys/fs/file-nr
net.ipv4.tcp_wmem = 4096 87380 4161536
net.ipv4.tcp_rmem = 4096 87380 4161536
net.ipv4.tcp_mem = 786432 2097152 3145728
fs.file-max = 1000000
fs.nr_open = 1000000
net.netfilter.nf_conntrack_max = 1048576
net.nf_conntrack_max = 1048576
sudo /sbin/sysctl -p

2. /etc/security/limits.conf
cat /proc/29875/limits
*         hard    nofile      1000000
*         soft    nofile      1000000
root      hard    nofile      1000000
root      soft    nofile      1000000

3. node
pm2 start app.js --node-args="--nouse-idle-notification --expose-gc --max-old-space-size=8192 --max-new-space-size=2048"

4. profile
npm install v8-profiler --save

export const profiler = require("v8-profiler");
export const fs = require("fs");

let profilerRunning = false;

export function toggleProfile() {
    if (profilerRunning) {
        const profile = libs.profiler.stopProfiling();
        console.log("stopped profiling");
        profile.export()
            .pipe(libs.fs.createWriteStream(`${Date.now()}.cpuprofile`))
            .once("error", libs.profiler.deleteAllProfiles)
            .once("finish", libs.profiler.deleteAllProfiles);
        profilerRunning = false;
    } else {
        libs.profiler.startProfiling();
        profilerRunning = true;
        console.log("started profiling");
    }
}

export function takeSnapshot() {
    const snapshot = libs.profiler.takeSnapshot();
    snapshot.export()
        .pipe(libs.fs.createWriteStream(`${Date.now()}.heapsnapshot`))
        .on("finish", snapshot.delete);
}
</pre>
<h2>install OS from USB</h2>
<pre>
1. open .iso file with UltraISO
2. click `启动光盘-写入硬盘映像`, `格式化` and `写入`
3. press ESC, F2 or F8 to enter BIOS, change the first reboot device
4. mind the network setting and set an user
</pre>
<h2>python server</h2>
<pre>
python -m SimpleHTTPServer
</pre>
<h2>go environment</h2>
<pre>
`go get -u github.com/golang/net github.com/golang/tools`
move to `golang.org/x/net` and `golang.org/x/tools`
`go run xyz.go`
</pre>
<h2>reload bashrc</h2>
<pre>
source ~/.bashrc
</pre>
<h2>disable support for export cipher suites and use a 2048-bit Diffie-Hellman group</h2>
<pre>
1. openssl dhparam -out dhparams.pem 2048
2. nginx
    ssl_ciphers 'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA';
    ssl_prefer_server_ciphers on;
    ssl_dhparam /opt/dhparams.pem;
</pre>
<h2>docker-gitlib</h2>
<pre>
1. docker: https://docs.docker.com/engine/installation/
2. docker-compose: https://docs.docker.com/compose/install/
3. wget https://raw.githubusercontent.com/sameersbn/docker-gitlab/master/docker-compose.yml
4. pwgen -Bsv1 64
5. docker-compose up -d
6. docker-compose.yml
    - GITLAB_HOST=git.yorkyao.xyz
    - GITLAB_PORT=443
    - GITLAB_HTTPS=true
7. nginx
    upstream gitlab {
        server localhost:10080;
    }

    server {
        listen       443 ssl http2;
        ssl on;
        ssl_certificate /opt/1_git.yorkyao.xyz_bundle.crt;
        ssl_certificate_key /opt/git_ssl.key;
        server_name git.yorkyao.xyz;

        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Frame-Options SAMEORIGIN;

        location / {
            proxy_pass http://gitlab;
        }
    }
</pre>
<h2>linux swap</h2>
<pre>
dd  if=/dev/zero  of=/swapfile1  bs=1024  count=524288
mkswap  /swapfile1
chown root:root /swapfile1
chmod 0600  /swapfile1
swapon  /swapfile1
vi    /etc/fstab
/swapfile1 swap swap defaults 0 0
free -m
</pre>
<h2>bash</h2>
<pre>
export ANDROID_HOME=/usr/local/opt/android-sdk
source ~/.bashrc
</pre>
<h2>git submodule</h2>
<pre>
git submodule update --init --recursive
</pre>
<h2>react with babel</h2>
<pre>
let babel = require("gulp-babel");
for (let file of jsxFiles) {
    gulp.src(`components/${file}.jsx`)
        .pipe(babel())
        .pipe(rename(`${file}.js`))
        .pipe(gulp.dest("build"));
}

`.babelrc`
{
    "presets": ["es2015", "react"]
}
</pre>
<h2>nginx proxy</h2>
<pre>
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }
    server {
        listen       9998;
        server_name  localhost;

        location ~*/socket.io/* {
            proxy_pass https://yorkyao.xyz;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
        }

        location / {
            add_header Access-Control-Allow-Origin http://localhost:8888;
            proxy_pass https://yorkyao.xyz;
        }
    }
    server {
        listen       9999;
        server_name  localhost;

        location / {
            add_header Access-Control-Allow-Origin http://localhost:8888;
            proxy_pass https://img.yorkyao.xyz;
        }
    }
    server {
        listen       7777;
        server_name  localhost;

        location / {
            proxy_pass https://img.yorkyao.xyz;
        }
    }
</pre>
<h2>nginx sample</h2>
<pre>
    gzip  on;
    gzip_http_version 1.1;
    gzip_vary on;
    gzip_comp_level 6;
    gzip_proxied any;
    gzip_types text/plain application/x-javascript text/css text/javascript application/x-httpd-php image/jpeg image/gif image/png;
    gzip_buffers 16 8k;
    gzip_disable "MSIE [1-6]\.(?!.*SV1)";

    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    keepalive_timeout   65;
    types_hash_max_size 2048;

    include             /etc/nginx/mime.types;
    default_type        application/octet-stream;

    # Load modular configuration files from the /etc/nginx/conf.d directory.
    # See http://nginx.org/en/docs/ngx_core_module.html#include
    # for more information.
    include /etc/nginx/conf.d/*.conf;

    server {
        listen       80;
        return       301 https://$host$request_uri;
    }

    upstream deployRobot {
        server localhost:9996;
    }
    server {
        listen       9995 ssl http2;
        listen       [::]:9995;
        ssl on;
        ssl_certificate /opt/1_yorkyao.xyz_bundle.crt;
        ssl_certificate_key /opt/ssl.key;
        server_name  yorkyao.xyz;

        location / {
            proxy_pass http://deployRobot;
        }
    }

    upstream imageUploader {
        server localhost:9999;
    }
    server {
        listen       443 ssl http2;
        listen       [::]:443;
        ssl on;
        ssl_certificate /opt/1_upload.yorkyao.xyz_bundle.crt;
        ssl_certificate_key /opt/upload_ssl.key;
        server_name  upload.yorkyao.xyz;

        location / {
            proxy_pass http://imageUploader;
            proxy_set_header        Host            $host;
            proxy_set_header        X-Real-IP       $remote_addr;
            proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }

    server {
        listen       443 ssl http2;
        listen       [::]:443;
        ssl on;
        ssl_certificate /opt/1_img.yorkyao.xyz_bundle.crt;
        ssl_certificate_key /opt/img_ssl.key;
        server_name  img.yorkyao.xyz;

        location ~*\.(jpg|jpeg|gif|png|ico|cur|gz|svg|svgz)$ {
            root         /opt/backends/images/;
            access_log off;
        }
    }

    server {
        listen       443 ssl http2;
        listen       [::]:443;
        ssl on;
        ssl_certificate /opt/1_doc.yorkyao.xyz_bundle.crt;
        ssl_certificate_key /opt/doc_ssl.key;
        server_name  doc.yorkyao.xyz;

        location ~*\.(js|css|jpg|jpeg|gif|png|ico|cur|gz|svgz|map|mp4|ogg|ogv|webm|htc|json|ttf|woff)$ {
            root         /opt/doc/_book;
            expires 1M;
            access_log off;
            add_header Cache-Control public;
        }
        location ~*\.(html|svg)$ {
            root         /opt/doc/_book;
            index index.html;
            access_log off;
        }
    }

    upstream backends {
        server localhost:9998;
    }
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }
    server {
        listen       443 ssl http2;
        listen       [::]:443;
        ssl on;
        ssl_certificate /opt/1_yorkyao.xyz_bundle.crt;
        ssl_certificate_key /opt/ssl.key;
        server_name yorkyao.xyz www.yorkyao.xyz;

        location ~*/socket.io/* {
            proxy_pass http://backends;
	        proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
        }
        location ~*\.(js|css|jpg|jpeg|gif|png|ico|cur|gz|svg|svgz|map|mp4|ogg|ogv|webm|htc|json|ttf|woff)$ {
            root         /opt/frontends/dest/;
            expires 1M;
            access_log off;
            add_header Cache-Control public;
        }
        location ~*\.html$ {
            root         /opt/frontends/dest/;
            try_files $uri /index.html;
            access_log off;
        }
        location =/ {
            root         /opt/frontends/dest/;
            index index.html;
            access_log off;
        }
        location / {
            proxy_pass http://backends;
            proxy_set_header        Host            $host;
            proxy_set_header        X-Real-IP       $remote_addr;
            proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
</pre>
<h2>SSL</h2>
<pre>
1. openssl rsa -in ssl.key -out ssl2.key
2. nginx
        listen       80;
        listen       443 ssl;
        listen       [::]:80;
        ssl on;
        ssl_certificate /opt/ssl.crt;
        ssl_certificate_key /opt/ssl2.key;
        server_name wosign.com www.wosign.com;
</pre>
<h2>XSS</h2>
<pre>
1. http only cookie
2. check the input from user
3. check the output to html
</pre>
<h2>CSRF</h2>
<pre>
1. captcha
2. check referer
3. token
</pre>
<h2>nginx</h2>
<pre>
1. install
http://nginx.org/en/docs/install.html
2. config
/etc/nginx
/usr/local/nginx/
/usr/local/etc/nginx/
3. reload
nginx -s reload
</pre>
<h2>cookie may be invalid in localhost</h2>
<h2>port</h2>
<pre>
netstat -ano | grep 80
</pre>
<h2>Segmentation fault: 11</h2>
<pre>
npm rebuild
</pre>
<h2>cron</h2>
<pre>
1. config
crontab -e
2. restart
for CentOS 5/6:
service crond restart
for CentOS 7:
systemctl restart crond.service
3. status
crontab -u root -l
service crond status
4. log
/var/log/cron
</pre>
<h2>website develop environment</h2>
<pre>
1. structure
2. cache
3. log
4. document
5. db
6. auto unit test
7. code repository
8. auto deploy
9. auto complie
10. backup
11. setting
</pre>
<h2>install mysql</h2>
<pre>
1. install
sudo apt-get install mysql-server
sudo apt-get install mysql-client
sudo apt-get install libmysqlclient-dev

2. check whether is mysql installed successfully
sudo netstat -tap | grep mysql

3. can access mysql from outside of the server
remove `bind-address = 127.0.0.1` from `/etc/mysql/my.conf`
</pre>
<h2>install mongodb</h2>
<pre>
https://www.mongodb.org/downloads

1. add admin user
mongo
use admin
db.system.users.find()
db.createUser(
  {
    user: "admin_user",
    pwd: "admin_password"
  }
)
db.auth('admin_user','admin_password')

2. add a user for a db
db.createUser(
    {
      user: "user",
      pwd: "password",
      roles: [
         { role: "readWrite", db: "db_name" }
      ]
    }
)

3. turn on auth and set ip
/etc/mongod.conf
</pre>
<h2>install redis</h2>
<pre>
http://redis.io/download
</pre>
<h2>change file format</h2>
<pre>
vim abc.sh
:set ff=unix
:set ff
:wq
</pre>
<h2>install git</h2>
<pre>
http://git-scm.com/download/linux
</pre>
<h2>install mariadb</h2>
<pre>
https://downloads.mariadb.org/mariadb/repositories/#mirror=opencas
sudo service mysql start
mysqladmin -u root password 'password'
</pre>
<h2>install nodejs</h2>
<pre>
https://github.com/joyent/node/wiki/Installing-Node.js-via-package-manager
</pre>
<h2>show pid</h2>
<pre>
ps aux | grep node
</pre>
<h2>nodejs auto deploy</h2>
<pre>
git clone XXX .
npm install --global gulp

cd XXX
git pull
gulp XXX
rsync -a XXX XXX
FOREVER_ROOT=XXX forever restart -l XXX.log XXX.js
</pre>
<h2>npm</h2>
<pre>
npm --registry https://registry.npm.taobao.org install socket.io
npm install -g n
n stable
</pre>
<h2>git</h2>
<pre>
git add -A
git reset --hard
git config --system core.longpaths true
</pre>
<h2>git pull request & fork workflow</h2>
<pre>
0. Create a team
1. Create the main repository, set permissions, clone, commit, push
2. Fork the repository, clone, commit, push, create pull request
3. Merge
</pre>
<h2>centos</h2>
<pre>
1. query memory
free -m
2. ssh
ssh -p 22 root@1.1.1.1
3. dns
/etc/resolv.conf
5. disk free in MB
df -m
6. query cpu status
top
q
7. query cpu
cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c 
8. query network
ifstat
</pre>
<h2>mysql</h2>
<pre>
1. Create Database 'database1', and grant it to new user 'user1/password1'
login: 
mysql -u root -p

create database:
show databases;
create database database1;
show databases;

create user:
select User,Host,Password from mysql.user;
CREATE USER 'user1'@'%' IDENTIFIED BY 'password1';
select User,Host,Password from mysql.user;

grant permissions:
grant select,insert,update,delete,create,drop,alter,create view,show view on database1.* to user1@'%' identified by 'password1';
flush privileges;
SHOW GRANTS FOR 'user1'@'%';

revoke permisions if necessary:
revoke all on database1.* from user1@'%';

2. backup
mysqldump -h 127.0.0.1 -u root -p dbname > /opt/filename.sql

3. query database size
use information_schema;
SELECT concat(round(sum(DATA_LENGTH/1024/1024),2),'MB') as data FROM TABLES WHERE table_schema='table name';
</pre>
<h2>Layout RenderSection</h2>
<pre>
1. Layout
@RenderSection("Head")
2. Body
@section Head{
    &lt;h2>Head&lt;/h2>
}
</pre>
<h2>Login by NT account</h2>
<pre>
1. Web.config
&lt;system.web>
    &lt;authentication mode="Windows">&lt;/authentication>
&lt;/system.web>
2. Code
HttpContext.Current.User.Identity.Name
3. IIS -> 身份验证
匿名是否验证：禁用
Windows验证：启用
4. IIS -> 应用程序池
v4.0/NetworkService/集成
5. 防火墙添加规则
</pre>
<h2>msi package</h2>
<pre>
msiexec /package "path-to-package"
</pre>
<h2>Comparer</h2>
<pre>
public class Product
{
    public string Name { get; set; }
    public int Code { get; set; }
}

public class ProductComparer : IEqualityComparer&lt;Product>
{
    public bool Equals(Product x, Product y)
    {
        if (Object.ReferenceEquals(x, y))
        {
            return true;
        }
        if (Object.ReferenceEquals(x, null) || Object.ReferenceEquals(y, null))
        {
            return false;
        }
        return x.Code == y.Code && x.Name == y.Name;
    }

    public int GetHashCode(Product product)
    {
        if (Object.ReferenceEquals(product, null))
        {
            return 0;
        }
        int hashProductName = product.Name == null ? 0 : product.Name.GetHashCode();
        int hashProductCode = product.Code.GetHashCode();
        return hashProductName ^ hashProductCode;
    }
}
</pre>
<h2>Unit test</h2>
<pre>
1.Run methods without run whole application
2.Unit test case shouldn't depend on other test cases
3.Use mock tool to help with that
</pre>
<h2>log4net</h2>
<pre>
[assembly: XmlConfigurator(Watch = true)]

public static class Log
{
    public static readonly ILog INSTANCE;
    static Log()
    {
        INSTANCE = LogManager.GetLogger(MethodBase.GetCurrentMethod().DeclaringType);
        if (INSTANCE == null)
        {
            throw new Exception("Log.INSTANCE == null");
        }
    }
}
</pre>

<pre>
&lt;configSections>
    &lt;section name="log4net" type="log4net.Config.Log4NetConfigurationSectionHandler,log4net" />
&lt;/configSections>
&lt;startup useLegacyV2RuntimeActivationPolicy="true">
    &lt;supportedRuntime version="v4.0" sku=".NETFramework,Version=v4.0" />
&lt;/startup>
&lt;log4net>
    &lt;root>
    &lt;appender-ref ref="UdpAppender" />
        &lt;!--&lt;appender-ref ref="RollingFileAppender"/>-->
    &lt;/root>
    &lt;appender name="UdpAppender" type="log4net.Appender.UdpAppender">
    &lt;remoteAddress value="127.0.0.1" />
    &lt;remotePort value="7071" />
        &lt;layout type="log4net.Layout.XmlLayoutSchemaLog4j" />
    &lt;/appender>
    &lt;!--&lt;appender name="RollingFileAppender" type="log4net.Appender.RollingFileAppender">
        &lt;file value="log.txt" />
        &lt;appendToFile value="true" />
        &lt;rollingStyle value="Size" />
        &lt;maxSizeRollBackups value="10" />
        &lt;maximumFileSize value="100KB" />
        &lt;staticLogFileName value="true" />
        &lt;layout type="log4net.Layout.PatternLayout">
            &lt;conversionPattern value="%date [%thread] %-5level - %message%newline" />
        &lt;/layout>
    &lt;/appender>-->
&lt;/log4net>
</pre>
<h2>web.config connectionStrings</h2>
<pre>
cd "C:\Windows\Microsoft.NET\Framework64\v4.0.30319"
aspnet_regiis.exe -pef   "connectionStrings"   "E:\inetpub\ABC" -prov "DataProtectionConfigurationProvider"
aspnet_regiis -pdf "connectionStrings" "E:\inetpub\ABC"
</pre>
<h2>file size</h2>
<pre>
&lt;form action="" method="POST" enctype="multipart/form-data">
&lt;/form>
&lt;system.web>
    &lt;httpRuntime
        maxRequestLength="40690"
        useFullyQualifiedRedirectUrl="true"
        executionTimeout="6000"
        minFreeThreads="8"
        minLocalRequestFreeThreads="4"
        appRequestQueueLimit="100"
        enableVersionHeader="true" />
&lt;/system.web>
</pre>
</body>
</html>
